<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Pilotos</title>
  <link rel="stylesheet" href="../style.css">
  <script defer src="../saveManager.js"></script>
  <script defer>
    let jogo = {};

    async function carregar() {
      jogo = loadGameData();
      if (!jogo) {
        alert("Jogo n√£o carregado.");
        location.href = "../index.html";
        return;
      }

      const pilotos = await fetch("../data/pilotos.json").then(r => r.json());
      const lista = document.getElementById("lista");
      lista.innerHTML = "";

      // Separar contratados dos dispon√≠veis
      const contratados = pilotos.filter(p => jogo.pilotos.includes(p.nome));
      const disponiveis = pilotos.filter(p => !jogo.pilotos.includes(p.nome) && (!p.equipe || p.equipe === ""));

      if (contratados.length > 0) {
        const titulo = document.createElement("h3");
        titulo.textContent = "Seus Pilotos";
        lista.appendChild(titulo);

        contratados.forEach(p => {
          const item = document.createElement("div");
          item.innerHTML = `<strong>${p.nome}</strong> (${p.pais}) - Talento: ${p.talento} <button onclick="demitir('${p.nome}')">Demitir</button>`;
          lista.appendChild(item);
        });
      }

      if (disponiveis.length > 0) {
        const titulo = document.createElement("h3");
        titulo.textContent = "Mercado de Pilotos";
        lista.appendChild(titulo);

        disponiveis.forEach(p => {
          const item = document.createElement("div");
          item.innerHTML = `
            <strong>${p.nome}</strong> (${p.pais}) - Talento: ${p.talento}
            <input type='number' placeholder='Sal√°rio por corrida' id='salario-${p.nome}' style='width:160px;'>
            <button onclick="tentarContratar('${p.nome}')">Contratar</button>
          `;
          lista.appendChild(item);
        });
      }
    }

    function tentarContratar(nome) {
      const input = document.getElementById(`salario-${nome}`);
      const valor = parseInt(input.value);

      if (isNaN(valor) || valor <= 0) {
        alert("Informe um valor de sal√°rio v√°lido.");
        return;
      }

      fetch("../data/pilotos.json")
        .then(r => r.json())
        .then(pilotos => {
          const piloto = pilotos.find(p => p.nome === nome);
          if (!piloto) return;

          if (jogo.pilotos.includes(nome)) {
            alert("Piloto j√° est√° contratado.");
            return;
          }

          if (jogo.pilotos.length >= 4) {
            alert("Voc√™ s√≥ pode ter at√© 4 pilotos.");
            return;
          }

          const interesse = piloto.interesseBase || 0.5;
          const notaFabrica = jogo.fabrica?.nota || 5.0;
          const chance = interesse + (notaFabrica - 5) * 0.1;

          if (valor < (piloto.salarioMinimo || 200000)) {
            alert(`‚ùå ${nome} recusou sua proposta. Valor abaixo do sal√°rio m√≠nimo exigido.`);
            return;
          }

          if (Math.random() > chance) {
            alert(`‚ùå ${nome} recusou sua proposta. N√£o acredita no potencial da sua equipe.`);
            return;
          }

          jogo.pilotos.push(nome);
          jogo.salarios = jogo.salarios || {};
          jogo.salarios[nome] = valor;

          jogo.ultimasNoticias = jogo.ultimasNoticias || [];
          jogo.ultimasNoticias.push(`‚úÖ Piloto ${nome} foi contratado pela equipe ${jogo.equipe} por $${valor.toLocaleString()} por corrida.`);
          if (jogo.ultimasNoticias.length > 20) jogo.ultimasNoticias = jogo.ultimasNoticias.slice(-20);

          saveGame(jogo);
          alert(`${nome} contratado com sucesso.`);
          location.reload();
        });
    }

    function demitir(nome) {
      const confirmacao = confirm(`Tem certeza que deseja demitir ${nome}?`);
      if (!confirmacao) return;

      const indice = jogo.pilotos.indexOf(nome);
      if (indice !== -1) {
        jogo.pilotos.splice(indice, 1);
        if (jogo.salarios) delete jogo.salarios[nome];

        jogo.ultimasNoticias = jogo.ultimasNoticias || [];
        jogo.ultimasNoticias.push(`üî• Piloto ${nome} foi demitido da equipe ${jogo.equipe}.`);
        if (jogo.ultimasNoticias.length > 20) jogo.ultimasNoticias = jogo.ultimasNoticias.slice(-20);

        saveGame(jogo);
        alert(`${nome} demitido.`);
        location.reload();
      }
    }

    window.onload = carregar;
  </script>
</head>
<body>
  <h1>Gest√£o de Pilotos</h1>
  <div id="lista"></div>
  <br>
  <button onclick="window.location.href='../menu-principal.html'">Voltar</button>
</body>
</html>
