<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Corrida - Simula√ß√£o Avan√ßada</title>
  <link rel="stylesheet" href="../style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script defer src="../saveManager.js"></script>
  <script defer>
    let jogo = {};

    function podeAdicionarNovaEquipe(listaEquipes) {
      const equipesAtivas = listaEquipes.filter(eq => eq.ativa !== false);
      return equipesAtivas.length < 13;
    }

    function substituirEquipeFalida(equipes) {
      const equipesAtivas = equipes.filter(e => e.ativa !== false);
      const equipesReservas = equipes.filter(e => e.ativa === false && !e.foiAtiva);

      if (equipesAtivas.length >= 13) return equipes;

      const novaEquipe = equipesReservas.shift();
      if (novaEquipe) {
        novaEquipe.ativa = true;
        novaEquipe.foiAtiva = true;
        novaEquipe.dinheiro = 1000000;
        novaEquipe.fabrica = { nota: 3.0 };
        novaEquipe.pilotos = [];
        novaEquipe.reservas = [];
        novaEquipe.staff = {};
        novaEquipe.patrocinadores = [];
        novaEquipe.progresso = { corridaAtual: 1 };
        novaEquipe.historicoFinanceiro = [];
        novaEquipe.ultimasNoticias = [`üÜï A equipe ${novaEquipe.nome} entrou no lugar de uma equipe falida.`];
      }

      return equipes;
    }

    async function simularCorrida() {
      jogo = loadGameData();
      if (!jogo || !jogo.ativo) {
        alert("Jogo n√£o carregado ou equipe falida.");
        location.href = "../menu.html";
        return;
      }

      const pistas = await fetch("../data/pistas.json").then(r => r.json());
      const pilotosBase = await fetch("../data/pilotos.json").then(r => r.json());
      const atual = jogo.progresso.corridaAtual - 1;

      if (atual >= pistas.length) {
        document.getElementById("resultado").textContent = "Temporada encerrada.";
        return;
      }

      const pista = pistas[atual];
      document.getElementById("info").textContent = `Corrida em ${pista.nome} - ${pista.pais}`;

      const grid = [];
      let pontuou = false;

      pilotosBase.forEach(p => {
        const equipe = (p.equipe && p.equipe !== "") ? p.equipe : "Equipe Extra";
        const isJogador = jogo.pilotos.includes(p.nome);
        const notaFabrica = isJogador ? jogo.fabrica.nota : Math.random() * 3 + 3;
        const motor = isJogador ? 1.0 : (Math.random() * 0.4 + 0.8);

        let performance = p.talento * (Math.random() * 0.3 + 0.85);
        performance *= notaFabrica;
        performance *= motor;

        const quebrou = Math.random() < 0.05;
        if (quebrou) performance = 0;

        grid.push({
          nome: p.nome,
          equipe: equipe,
          pontos: 0,
          desempenho: performance.toFixed(2),
          abandonou: quebrou
        });
      });

      grid.sort((a, b) => b.desempenho - a.desempenho);
      const pontuacao = [10, 6, 4, 3, 2, 1];

      grid.forEach((p, i) => {
        if (i < 6 && !p.abandonou) {
          p.pontos = pontuacao[i];
          if (jogo.pilotos.includes(p.nome)) pontuou = true;
        }
      });

      atualizarClassificacao(grid);
      jogo.progresso.corridaAtual++;

      // üí∞ Custo real de sal√°rios dos pilotos contratados
      let custoPilotos = 0;
      const detalhesPilotos = [];
      if (jogo.salarios) {
        jogo.pilotos.forEach(nome => {
          const salario = jogo.salarios[nome] || 200000;
          custoPilotos += salario;
          detalhesPilotos.push({ nome, salario });
        });
      }

      const custoStaff = (jogo.staff?.chefeEquipe ? 150000 : 0)
                       + (jogo.staff?.chefeDesign ? 120000 : 0)
                       + (jogo.staff?.engenheiro ? 100000 : 0);
      const custoFabrica = 180000;
      const custoOperacional = 250000;
      const saidas = custoPilotos + custoStaff + custoFabrica + custoOperacional;
      const patrocinio = (jogo.patrocinadores.length || 0) * 300000;
      const saldoCorrida = patrocinio - saidas;
      jogo.dinheiro += saldoCorrida;

      jogo.historicoFinanceiro = jogo.historicoFinanceiro || [];
      jogo.historicoFinanceiro.push({
        corrida: jogo.progresso.corridaAtual,
        entradas: patrocinio,
        saidas: saidas,
        saldo: saldoCorrida,
        caixa: jogo.dinheiro
      });

      if (jogo.dinheiro < 0) {
        jogo.falenciaCountdown = (jogo.falenciaCountdown || 2) - 1;
        if (jogo.falenciaCountdown <= 0) {
          alert("Sua equipe declarou fal√™ncia!");
          jogo.ativo = false;
          saveGame(jogo);
          location.href = "../fim.html";
          return;
        } else {
          alert(`‚ö†Ô∏è Seu caixa est√° negativo. Restam ${jogo.falenciaCountdown} corridas at√© a fal√™ncia.`);
        }
      } else {
        jogo.falenciaCountdown = 2;
      }

      if (jogo.progresso.corridaAtual % 3 === 0 && !pontuou && jogo.patrocinadores.length > 0) {
        const chance = Math.random();
        if (chance < 0.25) {
          const idx = Math.floor(Math.random() * jogo.patrocinadores.length);
          const perdido = jogo.patrocinadores.splice(idx, 1)[0];
          jogo.patrocinadorPerdido = perdido;
          alert(`üí∏ Voc√™ perdeu o patroc√≠nio de ${perdido} por desempenho fraco.`);
        } else {
          jogo.patrocinadorPerdido = null;
        }
      } else {
        jogo.patrocinadorPerdido = null;
      }

      if (jogo.equipes) {
        jogo.equipes = substituirEquipeFalida(jogo.equipes);
      }

      saveGame(jogo);
      mostrarResultado(grid);
      mostrarResumoFinanceiro(patrocinio, saidas, saldoCorrida, detalhesPilotos, jogo.historicoFinanceiro);
    }

    function atualizarClassificacao(grid) {
      const classif = loadClassificacao();
      grid.forEach(p => {
        if (p.abandonou) return;

        let piloto = classif.pilotos.find(pp => pp.nome === p.nome);
        if (!piloto) piloto = classif.pilotos[classif.pilotos.push({ nome: p.nome, pontos: 0 }) - 1];
        piloto.pontos += p.pontos;

        let equipe = classif.equipes.find(ee => ee.nome === p.equipe);
        if (!equipe) equipe = classif.equipes[classif.equipes.push({ nome: p.equipe, pontos: 0 }) - 1];
        equipe.pontos += p.pontos;
      });
      saveClassificacao(classif);
    }

    function mostrarResultado(grid) {
      const div = document.getElementById("resultado");
      div.innerHTML = "<h3>Resultado da Corrida</h3>";
      grid.forEach((p, i) => {
        const linha = document.createElement("p");
        linha.textContent = `${i + 1}¬∫ - ${p.nome} (${p.equipe}) ${p.abandonou ? "- Abandonou" : `- ${p.pontos} pts`}`;
        div.appendChild(linha);
      });
    }

    function mostrarResumoFinanceiro(patrocinio, saidas, saldo, pilotos, historico) {
      const div = document.getElementById("financeiro");
      div.innerHTML = `
        <h3>Resumo Financeiro</h3>
        <p>Patroc√≠nio recebido: $${patrocinio.toLocaleString()}</p>
        <p>Custo com staff/f√°brica/operacional: $${(saidas - pilotos.reduce((s, p) => s + p.salario, 0)).toLocaleString()}</p>
        <p>Custo com pilotos:</p>
        <ul>${pilotos.map(p => `<li>${p.nome}: $${p.salario.toLocaleString()}</li>`).join("")}</ul>
        <p><strong>Sa√≠das totais:</strong> $${saidas.toLocaleString()}</p>
        <p><strong>Saldo da corrida:</strong> $${saldo.toLocaleString()}</p>
        <canvas id="graficoCaixa" width="400" height="150"></canvas>
      `;

      const ctx = document.getElementById("graficoCaixa").getContext("2d");
      new Chart(ctx, {
        type: "line",
        data: {
          labels: historico.map(h => `Corrida ${h.corrida}`),
          datasets: [{
            label: "Evolu√ß√£o do Caixa",
            data: historico.map(h => h.caixa),
            borderColor: "lime",
            backgroundColor: "rgba(0,255,0,0.2)",
            tension: 0.3
          }]
        },
        options: {
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    window.onload = simularCorrida;
  </script>
</head>
<body>
  <h1>Simula√ß√£o de Corrida</h1>
  <p id="info"></p>
  <div id="resultado"></div>
  <div id="financeiro"></div>
  <br>
  <button onclick="location.href='../menu-principal.html'">Voltar</button>
  <button onclick="saveGame(jogo)">Salvar</button>
  <button onclick="location.reload()">Carregar</button>
  <button onclick="localStorage.clear(); alert('Jogo resetado'); location.href='../menu.html';">Resetar</button>
</body>
</html>
