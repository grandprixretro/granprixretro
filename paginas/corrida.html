<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Corrida - Simula√ß√£o Avan√ßada</title>
  <link rel="stylesheet" href="../style.css">
  <script defer src="../saveManager.js"></script>
  <script defer src="../data/pilotos.json"></script>
  <script defer>
    let jogo = {};

    async function simularCorrida() {
      jogo = loadGameData();
      if (!jogo) {
        alert("Jogo n√£o carregado.");
        location.href = "../menu.html";
        return;
      }

      const pistas = await fetch("../data/pistas.json").then(r => r.json());
      const pilotosBase = await fetch("../data/pilotos.json").then(r => r.json());
      const atual = jogo.progresso.corridaAtual - 1;

      if (atual >= pistas.length) {
        document.getElementById("resultado").textContent = "Temporada encerrada.";
        return;
      }

      const pista = pistas[atual];
      document.getElementById("info").textContent = `Corrida em ${pista.nome} - ${pista.pais}`;

      const grid = [];
      let pontuou = false;

      pilotosBase.forEach(p => {
        const equipe = (p.equipe && p.equipe !== "") ? p.equipe : "Equipe Extra";
        const isJogador = jogo.pilotos.includes(p.nome);
        const notaFabrica = isJogador ? jogo.fabrica.nota : Math.random() * 3 + 3;
        const motor = isJogador ? 1.0 : (Math.random() * 0.4 + 0.8);

        let performance = p.talento * (Math.random() * 0.3 + 0.85);
        performance *= notaFabrica;
        performance *= motor;

        const quebrou = Math.random() < 0.05;
        if (quebrou) {
          performance = 0;
        }

        grid.push({
          nome: p.nome,
          equipe: equipe,
          pontos: 0,
          desempenho: performance.toFixed(2),
          abandonou: quebrou
        });
      });

      grid.sort((a, b) => b.desempenho - a.desempenho);
      const pontuacao = [10, 6, 4, 3, 2, 1];

      grid.forEach((p, i) => {
        if (i < 6 && !p.abandonou) {
          p.pontos = pontuacao[i];
          if (jogo.pilotos.includes(p.nome)) pontuou = true;
        }
      });

      atualizarClassificacao(grid);
      jogo.progresso.corridaAtual++;

      // -----------------------
      // üî¥ Sistema de fal√™ncia
      // -----------------------
      if (jogo.dinheiro < 0) {
        jogo.falenciaCountdown = (jogo.falenciaCountdown || 2) - 1;
        if (jogo.falenciaCountdown <= 0) {
          alert("Sua equipe declarou fal√™ncia!");
          jogo.ativo = false;
          saveGame(jogo);
          location.href = "../fim.html";
          return;
        } else {
          alert(`‚ö†Ô∏è Seu caixa est√° negativo. Restam ${jogo.falenciaCountdown} corridas at√© a fal√™ncia.`);
        }
      } else {
        jogo.falenciaCountdown = 2;
      }

      // ------------------------------------------
      // üî¥ Perda de patrocinador por desempenho ruim
      // ------------------------------------------
      if (jogo.progresso.corridaAtual % 3 === 0 && !pontuou && jogo.patrocinadores.length > 0) {
        const chance = Math.random();
        if (chance < 0.25) {
          const idx = Math.floor(Math.random() * jogo.patrocinadores.length);
          const perdido = jogo.patrocinadores.splice(idx, 1)[0];
          jogo.patrocinadorPerdido = perdido;
          alert(`üí∏ Voc√™ perdeu o patroc√≠nio de ${perdido} por desempenho fraco.`);
        } else {
          jogo.patrocinadorPerdido = null;
        }
      } else {
        jogo.patrocinadorPerdido = null;
      }

      saveGame(jogo);
      mostrarResultado(grid);
    }

    function atualizarClassificacao(grid) {
      const classif = loadClassificacao();

      grid.forEach(p => {
        if (p.abandonou) return;

        let piloto = classif.pilotos.find(pp => pp.nome === p.nome);
        if (!piloto) {
          piloto = { nome: p.nome, pontos: 0 };
          classif.pilotos.push(piloto);
        }
        piloto.pontos += p.pontos;

        let equipe = classif.equipes.find(ee => ee.nome === p.equipe);
        if (!equipe) {
          equipe = { nome: p.equipe, pontos: 0 };
          classif.equipes.push(equipe);
        }
        equipe.pontos += p.pontos;
      });

      saveClassificacao(classif);
    }

    function mostrarResultado(grid) {
      const div = document.getElementById("resultado");
      div.innerHTML = "";

      grid.forEach((p, i) => {
        const pos = i + 1;
        const linha = document.createElement("p");
        linha.textContent = `${pos}¬∫ - ${p.nome} (${p.equipe}) ${p.abandonou ? "- Abandonou" : `- ${p.pontos} pts`}`;
        div.appendChild(linha);
      });
    }

    window.onload = simularCorrida;
  </script>
</head>
<body>
  <h1>Simula√ß√£o de Corrida</h1>
  <p id="info"></p>
  <div id="resultado"></div>
  <br>
  <button onclick="location.href='../menu-principal.html'">Voltar</button>
  <button onclick="saveGame(jogo)">Salvar</button>
  <button onclick="location.reload()">Carregar</button>
  <button onclick="localStorage.clear(); alert('Jogo resetado'); location.href='../menu.html';">Resetar</button>
</body>
</html>
