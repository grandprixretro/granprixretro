<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Fábrica</title>
  <link rel="stylesheet" href="../style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
  <script src="../saveManager.js"></script>
  <style>
    body {
      background-color: black;
      color: white;
      font-family: 'Press Start 2P', monospace;
      padding: 20px;
    }
    h1, h2 {
      color: red;
      font-size: 14px;
      margin-bottom: 20px;
    }
    p {
      font-size: 10px;
      margin: 6px 0;
    }
    button {
      background-color: black;
      color: white;
      border: 2px solid red;
      padding: 10px 15px;
      margin: 6px;
      font-family: 'Press Start 2P', monospace;
      font-size: 10px;
      cursor: pointer;
    }
    button:hover {
      background-color: red;
      color: black;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      border-color: grey;
    }
  </style>
</head>
<body>
  <h1>Fábrica da Equipe</h1>
  <p><strong>Equipe:</strong> <span id="equipe"></span></p>
  <p><strong>Motor:</strong> <span id="motor"></span></p>
  <p><strong>Confiabilidade do Motor:</strong> <span id="confiabilidade"></span>%</p>
  <p><strong>Dinheiro disponível:</strong> <span id="dinheiro"></span></p>
  <p><strong>Total investido na temporada:</strong> <span id="investido"></span></p>
  <p><strong>Manutenção:</strong> <span id="status-manutencao">Inativa</span></p>

  <h2>Departamentos</h2>
  <p><strong>Técnico:</strong> <span id="tecnico"></span>%</p>
  <p><strong>R&D:</strong> <span id="rd"></span>%</p>
  <p><strong>Estrat. Corrida:</strong> <span id="estrategia"></span>%</p>
  <p><strong>Pit-Stop:</strong> <span id="pitstop"></span>%</p>
  <p><strong>Marketing:</strong> <span id="marketing"></span>%</p>
  <p><strong>Nível da Fábrica:</strong> <span id="nivel"></span>%</p>

  <h2>Investir na Fábrica</h2>
  <button id="btn1">Investir $1M</button>
  <button id="btn2">Investir $2M</button>
  <button id="btn5">Investir $5M</button>
  <br />
  <button id="btnMelhorarMotor">Melhorar motor ($1M)</button>
  <br />
  <button id="btnManutencao">Alternar Manutenção</button>
  <br /><br />
  <button onclick="window.location.href='../menu-principal.html'">Voltar</button>

  <script>
    let jogo = {};

    function atualizarInterface() {
      document.getElementById("equipe").textContent = jogo.equipe;
      document.getElementById("motor").textContent = jogo.motor;
      // Atualiza a confiabilidade do motor. Se não existir, assume 70%.
      const confiab = typeof jogo.motorConfiabilidade === 'number' ? jogo.motorConfiabilidade : 70;
      document.getElementById("confiabilidade").textContent = confiab.toFixed(1);
      document.getElementById("dinheiro").textContent = "$" + jogo.dinheiro.toLocaleString();
      document.getElementById("investido").textContent = "$" + (jogo.fabrica.investimentoTotal || 0).toLocaleString();
      document.getElementById("status-manutencao").textContent = jogo.fabrica.manutencaoAtiva ? "Ativa" : "Inativa";

      const staff = jogo.staff || [];
      const get = cargo => staff.find(p => p.cargo === cargo)?.habilidade || 0;

      const tecnico = get("Diretor Técnico") * 0.20;
      const rd = get("Chefe de R&D") * 0.30;
      const estrategia = get("Chefe de Equipe") * 0.20;
      const pitstop = get("Chefe de Corrida") * 0.20;
      const marketing = get("Diretor de Marketing") * 0.10;

      const nivelTotal = tecnico + rd + estrategia + pitstop + marketing;
      const nivelPorcento = nivelTotal.toFixed(1);

      document.getElementById("tecnico").textContent = (get("Diretor Técnico")).toFixed(1);
      document.getElementById("rd").textContent = (get("Chefe de R&D")).toFixed(1);
      document.getElementById("estrategia").textContent = (get("Chefe de Equipe")).toFixed(1);
      document.getElementById("pitstop").textContent = (get("Chefe de Corrida")).toFixed(1);
      document.getElementById("marketing").textContent = (get("Diretor de Marketing")).toFixed(1);
      document.getElementById("nivel").textContent = nivelPorcento;

      // Atualiza as notas no objeto de jogo: nivel (0-1) e nota (0-100)
      jogo.fabrica.nivel = nivelTotal / 100;
      jogo.fabrica.nota = nivelTotal;
      saveGameData(jogo);

      const fabricaMax = nivelPorcento >= 100;
      document.getElementById("btn1").disabled = fabricaMax;
      document.getElementById("btn2").disabled = fabricaMax;
      document.getElementById("btn5").disabled = fabricaMax;

      // Desabilita melhoria de motor quando atingir 100%
      const motorMax = confiab >= 100;
      document.getElementById("btnMelhorarMotor").disabled = motorMax;
    }

    function investir(valor) {
      if (jogo.dinheiro < valor) {
        alert("Dinheiro insuficiente.");
        return;
      }

      jogo.dinheiro -= valor;
      jogo.fabrica.investimentoTotal = (jogo.fabrica.investimentoTotal || 0) + valor;
      saveGameData(jogo);
      atualizarInterface();
    }

    function alternarManutencao() {
      jogo.fabrica.manutencaoAtiva = !jogo.fabrica.manutencaoAtiva;
      saveGameData(jogo);
      atualizarInterface();
    }

    // Aumenta a confiabilidade do motor investindo dinheiro.
    function melhorarMotor() {
      const custo = 1000000; // 1M por melhoria
      const incremento = 5;  // cada melhoria aumenta 5%
      const confiab = typeof jogo.motorConfiabilidade === 'number' ? jogo.motorConfiabilidade : 70;
      if (confiab >= 100) {
        alert("Confiabilidade máxima já alcançada.");
        return;
      }
      if (jogo.dinheiro < custo) {
        alert("Dinheiro insuficiente.");
        return;
      }
      jogo.dinheiro -= custo;
      jogo.motorConfiabilidade = Math.min(confiab + incremento, 100);
      saveGameData(jogo);
      atualizarInterface();
    }

    window.addEventListener("DOMContentLoaded", () => {
      jogo = loadGameData();

      if (!jogo || !jogo.fabrica) {
        alert("Jogo não carregado corretamente.");
        window.location.href = "../index.html";
        return;
      }
      // Se staff não estiver definido (por exemplo, no início do jogo), inicia como lista vazia
      if (!jogo.staff) {
        jogo.staff = [];
      }

      if (jogo.fabrica.manutencaoAtiva === undefined) {
        jogo.fabrica.manutencaoAtiva = false;
      }

      document.getElementById("btn1").onclick = () => investir(1000000);
      document.getElementById("btn2").onclick = () => investir(2000000);
      document.getElementById("btn5").onclick = () => investir(5000000);
      document.getElementById("btnMelhorarMotor").onclick = melhorarMotor;
      document.getElementById("btnManutencao").onclick = alternarManutencao;

      atualizarInterface();
    });
  </script>
</body>
</html>
